<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ’çƒå°ˆæ¥­è¨ˆåˆ†ç³»çµ± V4.4 (Trophy Resized)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #020617; color: white; overflow: hidden; font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif; height: 100vh; }
        .score-font { font-family: 'Impact', 'Arial Black', sans-serif; font-size: 42vh; line-height: 0.8; flex-grow: 1; display: flex; align-items: center; justify-content: center; }
        .on-the-hill { color: #facc15 !important; text-shadow: 0 0 60px rgba(250, 204, 21, 0.8); }
        .neon-title { position: absolute; top: 2vh; left: 50%; transform: translateX(-50%); font-size: 3rem; font-weight: 900; font-style: italic; text-transform: uppercase; letter-spacing: 0.2em; color: #60a5fa; text-shadow: 0 0 10px rgba(59, 130, 246, 0.8); z-index: 100; white-space: nowrap; }
        .overlay-bg { position: fixed; inset: 0; background: rgba(2, 6, 23, 0.95); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 400; padding: 2rem; backdrop-filter: blur(10px); }
        .mode-btn { background: rgba(30, 41, 59, 0.7); border: 2px solid #3b82f6; padding: 1.5rem; border-radius: 1.5rem; text-align: center; transition: 0.2s; cursor: pointer; width: 100%; font-weight: 900; font-size: 2rem; color: white; }
        .mode-btn:hover { background: #3b82f6; transform: scale(1.03); }
        .center-race-bar { background: rgba(15, 23, 42, 0.95); border: 3px solid #3b82f6; padding: 0.8rem 2.5rem; border-radius: 2.5rem; text-align: center; box-shadow: 0 0 40px rgba(59, 130, 246, 0.4); min-width: 220px; position: relative; }
        .control-row { display: flex; gap: 1.2rem; width: 100%; height: 13vh; padding: 0 2rem; margin-bottom: 2.5rem; }
        .plus-btn { flex: 5; border-radius: 1.5rem; font-size: 4.5rem; font-weight: 900; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .minus-btn { flex: 1.2; border-radius: 1.5rem; font-size: 2.5rem; font-weight: 900; display: flex; align-items: center; justify-content: center; background: #1e293b; border: 2px solid #334155; color: #94a3b8; cursor: pointer; }
        .win-tag { font-size: 1.1rem; color: #facc15; font-weight: 900; background: rgba(30, 41, 59, 0.9); padding: 4px 12px; border-radius: 8px; margin-left: 10px; border: 1px solid rgba(250, 204, 21, 0.3); }
        .race-btn { border: 2px solid #3b82f6; padding: 0.5rem 1.5rem; border-radius: 0.75rem; font-weight: 900; color: #60a5fa; transition: 0.2s; }
        .race-btn.active { background: #3b82f6; color: white; }
        .last-winner-chip { background: #ef4444; color: white; padding: 6px 18px; border-radius: 50px; font-size: 1rem; font-weight: 900; white-space: nowrap; }
        .fullscreen-setting-btn { position: absolute; top: 2rem; right: 2rem; background: rgba(59, 130, 246, 0.2); border: 1px solid rgba(59, 130, 246, 0.5); color: #60a5fa; padding: 0.6rem 1.2rem; border-radius: 0.5rem; font-weight: bold; cursor: pointer; z-index: 501; }
        
        /* â˜…â˜…â˜… ä¿®æ”¹ï¼šæ‡¸æµ®çç›ƒæ¨£å¼ (ç¸®å°ä¸¦æ‹‰é•·) â˜…â˜…â˜… */
        .big-trophy {
            position: absolute;
            top: 50%;
            /* 1. ç¸®å°åŸºç¤å¤§å° (åŸæœ¬ 10rem -> ç¾åœ¨ 6rem, ç´„60%) */
            font-size: 6rem; 
            filter: drop-shadow(0 0 30px rgba(234, 179, 8, 0.6));
            z-index: 50;
            opacity: 0;
            /* åˆå§‹ç‹€æ…‹ï¼šå‚ç›´ç½®ä¸­ï¼Œç¨å¾®ç¸®å°ä¸€é»ä»¥ä¾¿ç”¢ç”Ÿå½ˆè·³æ„Ÿ */
            transform: translateY(-50%) scale(0.8, 1);
            transition: opacity 0.5s ease-in-out, transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .big-trophy.show {
            opacity: 1;
            /* 2. é¡¯ç¤ºç‹€æ…‹ï¼šå‚ç›´ç½®ä¸­ï¼Œå¯¬åº¦æ­£å¸¸(1)ï¼Œé«˜åº¦æ‹‰é•·20%(1.2) */
            transform: translateY(-50%) scale(1, 1.2);
        }
    </style>
</head>
<body class="flex flex-col h-screen relative">
    <div id="gameModeIndicator" class="neon-title">æ¨¡å¼é¸æ“‡</div>

    <div id="modeOverlay" class="overlay-bg">
        <button onclick="toggleFullScreen()" class="fullscreen-setting-btn">å…¨è¢å¹•åˆ‡æ›</button>
        <h2 class="text-5xl font-black mb-12 italic text-blue-400 uppercase">è«‹é¸æ“‡æ¯”è³½æ¨¡å¼</h2>
        <div class="grid grid-cols-2 gap-8 w-full max-w-4xl px-4">
            <button onclick="selectMode('å¹³é»è³½')" class="mode-btn">å¹³é»è³½</button>
            <button onclick="selectMode('è®“å±€è³½')" class="mode-btn border-emerald-500 text-emerald-400">è®“å±€è³½</button>
            <button onclick="selectMode('é›™æ®ºé™å±€è³½')" class="mode-btn border-purple-500 text-purple-400">é›™æ®ºé™å±€è³½</button>
            <button onclick="selectMode('æ“‚å°è³½')" class="mode-btn border-red-500 text-red-400">æ“‚å°è³½</button>
            <button onclick="selectMode('3-3-1 é©Ÿæ­»è³½')" class="mode-btn border-orange-500 text-orange-400 col-span-2">3-3-1 é©Ÿæ­»è³½</button>
        </div>
    </div>

    <div id="playerOverlay" class="overlay-bg" style="display: none;">
        <button onclick="toggleFullScreen()" class="fullscreen-setting-btn">å…¨è¢å¹•åˆ‡æ›</button>
        <h2 id="currentModeTitle" class="text-3xl font-black mb-10 text-yellow-500 italic">æ¨¡å¼</h2>
        <div class="flex flex-col md:flex-row items-center gap-10 mb-14">
            <div class="flex flex-col gap-4 bg-slate-900/60 p-6 rounded-[2rem] border border-blue-500/30">
                <select id="gradeA" onchange="updateNameList('A')" class="bg-slate-800 p-3 rounded-xl text-xl w-64 text-white font-bold"></select>
                <select id="selectA" class="bg-slate-800 border-2 border-blue-500 p-4 rounded-xl text-2xl w-64 text-blue-400 font-bold"></select>
            </div>
            <div class="text-5xl font-black text-slate-800 italic">VS</div>
            <div class="flex flex-col gap-4 bg-slate-900/60 p-6 rounded-[2rem] border border-red-500/30">
                <select id="gradeB" onchange="updateNameList('B')" class="bg-slate-800 p-3 rounded-xl text-xl w-64 text-white font-bold"></select>
                <select id="selectB" class="bg-slate-800 border-2 border-red-500 p-4 rounded-xl text-2xl w-64 text-red-500 font-bold"></select>
            </div>
        </div>
        <button id="startBtn" onclick="checkMatchHistory()" class="bg-blue-600 text-white px-20 py-5 rounded-full text-3xl font-black italic">è¼‰å…¥é¸æ‰‹è³‡æ–™</button>
    </div>

    <div id="previewOverlay" class="overlay-bg" style="display: none;">
        <div class="bg-slate-900/90 border-2 border-blue-500 p-10 rounded-[3rem] text-center max-w-4xl w-full">
            <div class="mb-6 flex justify-center gap-3">
                <span id="welcomeLabel" class="welcome-chip hidden">ğŸ‘‹ åˆæ¬¡å°æ±ºï¼</span>
                <span id="preLastWinnerArea" class="last-winner-chip hidden">ğŸ”¥ å‰å ´å‹æ–¹ï¼š<span id="preLastWinnerName"></span></span>
            </div>
            <div id="customRaceArea" class="mb-10 p-6 bg-blue-900/20 rounded-2xl border border-blue-500/30 hidden">
                <p class="text-yellow-500 font-bold mb-4 italic">é«˜æ‰‹å°æ±ºï¼šè«‹é¸æ“‡æ¯”è³½å±€æ•¸</p>
                <div class="flex justify-center gap-4">
                    <button onclick="setCustomRace(3)" class="race-btn" id="race3">æ¶ 3</button>
                    <button onclick="setCustomRace(5)" class="race-btn active" id="race5">æ¶ 5</button>
                    <button onclick="setCustomRace(7)" class="race-btn" id="race7">æ¶ 7</button>
                    <button onclick="setCustomRace(9)" class="race-btn" id="race9">æ¶ 9</button>
                </div>
            </div>
            <div class="flex justify-around items-center mb-10">
                <div class="text-center"><div id="preNameA" class="text-4xl font-black"></div><div id="preStatsA" class="text-emerald-400 text-xl font-bold mt-2"></div></div>
                <div class="text-3xl italic font-black text-slate-700">VS</div>
                <div class="text-center"><div id="preNameB" class="text-4xl font-black"></div><div id="preStatsB" class="text-emerald-400 text-xl font-bold mt-2"></div></div>
            </div>
            <button id="confirmBtn" onclick="confirmStart()" class="w-full bg-blue-600 py-6 rounded-2xl font-black text-3xl italic">ç¢ºèªé–‹å§‹æ¯”è³½</button>
        </div>
    </div>

    <div id="setWinOverlay" class="overlay-bg" style="display: none; z-index: 550; background: rgba(2, 6, 23, 0.85);">
        <div class="text-6xl animate-bounce mb-6">âœ¨</div>
        <h2 id="setWinTitle" class="text-5xl font-black text-yellow-400 italic mb-4 uppercase">Set Won!</h2>
        <div id="setWinMsg" class="text-3xl text-white font-bold mb-10 text-center leading-relaxed"></div>
        <button onclick="nextSetAction()" class="bg-blue-600 hover:bg-blue-500 text-white px-16 py-5 rounded-full text-2xl font-black italic shadow-lg active:scale-95 transition-all">
            ä¸‹ä¸€ç›¤é–‹å§‹
        </button>
    </div>

    <div class="h-[10vh] flex items-center justify-between px-10 z-20">
        <button onclick="resetGame()" class="text-slate-600 font-bold uppercase text-xs">é‡æ–°é¸æ“‡</button>
        <button id="mainSaveBtn" onclick="saveProgress()" class="text-emerald-400 font-bold border border-emerald-500/40 px-4 py-1.5 rounded-lg text-xs">å„²å­˜ç›®å‰é€²åº¦</button>
    </div>

    <div class="center-info-area" style="position: absolute; left: 50%; top: 55%; transform: translate(-50%, -50%); display: flex; flex-direction: column; align-items: center; z-index: 10;">
        <div id="boardLastWinnerArea" class="hidden mb-4"><span class="last-winner-chip">ğŸ”¥ å‰å ´å‹æ–¹ï¼š<span id="boardLastWinnerName"></span></span></div>
        <div class="center-race-bar">
            <div class="text-slate-500 text-[10px] font-bold uppercase mb-1">ç›®æ¨™å±€æ•¸</div>
            <div id="raceDisplay" class="text-5xl font-black text-blue-500 italic">5</div>
        </div>
    </div>

    <div class="flex-grow flex overflow-hidden">
        <div class="flex-1 flex flex-col border-r border-slate-900/50 relative"> 
            <div id="trophyA" class="big-trophy left-8">ğŸ†</div>
            <div class="flex flex-col items-center mt-10">
                <div class="flex items-center gap-3"> 
                    <span id="displayNameA" class="text-5xl font-black text-blue-400 uppercase">é¸æ‰‹ A</span>
                    <span id="sideStatA" class="win-tag">0 å‹</span>
                </div>
                <div id="adjLabelA" class="text-xs text-slate-500 font-bold mt-1"></div>
            </div>
            <div id="scoreA" class="score-font select-none">0</div>
            <div class="control-row"><button onclick="changeScore('A', -1)" class="minus-btn">-</button><button onclick="changeScore('A', 1)" class="plus-btn bg-blue-600 text-white">+</button></div>
        </div>

        <div class="flex-1 flex flex-col relative"> 
            <div id="trophyB" class="big-trophy right-8">ğŸ†</div>
            <div class="flex flex-col items-center mt-10">
                <div class="flex items-center gap-3">
                    <span id="displayNameB" class="text-5xl font-black text-red-500 uppercase">é¸æ‰‹ B</span>
                    <span id="sideStatB" class="win-tag">0 å‹</span>
                </div>
                <div id="adjLabelB" class="text-xs text-slate-500 font-bold mt-1"></div>
            </div>
            <div id="scoreB" class="score-font select-none">0</div>
            <div class="control-row"><button onclick="changeScore('B', 1)" class="plus-btn bg-red-600 text-white">+</button><button onclick="changeScore('B', -1)" class="minus-btn">-</button></div>
        </div>
    </div>

    <div id="winOverlay" class="overlay-bg" style="display:none; z-index: 600; backdrop-filter: blur(20px);">
        <div class="text-[15rem] mb-8 animate-bounce">ğŸ†</div>
        <h2 class="text-5xl font-black text-yellow-500 uppercase italic tracking-widest mb-4">Champion</h2>
        <h1 id="winnerLabel" class="text-8xl font-black text-white uppercase italic text-center drop-shadow-[0_0_30px_rgba(255,255,255,0.5)] mb-10">é¸æ‰‹å§“å</h1>
        <button onclick="resetGame()" class="mt-8 bg-yellow-600 hover:bg-yellow-500 text-white px-24 py-6 rounded-full font-black text-3xl italic shadow-2xl active:scale-95 transition-all">
            ä¸‹ä¸€å ´å°æ±º
        </button>
    </div>

    <script>
        // â˜…â˜…â˜… è«‹ç¢ºèªæ­¤ç¶²å€æ­£ç¢º â˜…â˜…â˜…
        const GAS_URL = "https://script.google.com/macros/s/AKfycbwF5Xm1mZqHl9X0gYiPMx8rfrm9g-w0Ob9iSd_0n7DyRh-p1UwFHxmZGFMGNswJvgIZ/exec"; 
        
        let scoreA = 0, scoreB = 0, raceGoalA = 5, raceGoalB = 5;
        let playerList = [], currentHistory = {aWin:0, bWin:0}, currentHandicaps = {adjA:0, adjB:0}, lastWinnerName = "", selectedCustomRace = 5, currentMode = "", savedData = null;
        let serverRecRace = 3;
        let currentSetScore = {a: 0, b: 0};
        let pendingSetWinner = null; 

        function toggleFullScreen() {
            if (!document.fullscreenElement) document.documentElement.requestFullscreen().catch(e => console.log(e.message));
            else if (document.exitFullscreen) document.exitFullscreen();
        }

        function resetGame() {
            document.getElementById('winOverlay').style.display = 'none';
            document.getElementById('setWinOverlay').style.display = 'none';
            document.getElementById('previewOverlay').style.display = 'none';
            document.getElementById('playerOverlay').style.display = 'none';
            document.getElementById('modeOverlay').style.display = 'flex';
            document.getElementById('gameModeIndicator').innerText = "æ¨¡å¼é¸æ“‡";
            document.getElementById('boardLastWinnerArea').classList.add('hidden');
            
            document.getElementById('trophyA').classList.remove('show');
            document.getElementById('trophyB').classList.remove('show');
            document.getElementById('raceDisplay').classList.remove('text-red-600', 'animate-pulse');
            document.getElementById('raceDisplay').classList.add('text-blue-500');

            scoreA = 0; scoreB = 0; savedData = null; 
            currentSetScore = {a: 0, b: 0}; 
            updateVisuals();
        }

        async function fetchPlayers() {
            try {
                document.getElementById('startBtn').innerText = "é€£ç·šä¸­...";
                const response = await fetch(GAS_URL);
                if (!response.ok) throw new Error("é€£ç·šå¤±æ•—");
                let text = await response.text();
                try { playerList = JSON.parse(text); } catch(e) { throw new Error("è³‡æ–™æ ¼å¼éŒ¯èª¤"); }
                if (!playerList || playerList.length === 0) throw new Error("è®€ä¸åˆ°é¸æ‰‹è³‡æ–™");
                
                const grades = [...new Set(playerList.map(p => p.å¹´ç´š))].filter(g => g).sort();
                ['gradeA', 'gradeB'].forEach(id => {
                    const sel = document.getElementById(id); sel.innerHTML = '<option value="">é¸æ“‡å¹´ç´š</option>';
                    grades.forEach(g => { let opt = document.createElement('option'); opt.value = g; opt.text = g; sel.appendChild(opt); });
                });
                document.getElementById('startBtn').innerText = "è¼‰å…¥é¸æ‰‹è³‡æ–™";
            } catch (e) { 
                console.error(e); alert("é€£ç·šç™¼ç”ŸéŒ¯èª¤ï¼š" + e.message);
                document.getElementById('startBtn').innerText = "è®€å–å¤±æ•—";
            }
        }

        function updateNameList(side) {
            const grade = document.getElementById('grade' + side).value;
            const sel = document.getElementById('select' + side);
            sel.innerHTML = '<option value="">é¸æ“‡é¸æ‰‹</option>';
            playerList.filter(p => String(p.å¹´ç´š) === String(grade)).forEach(p => {
                let opt = document.createElement('option'); 
                opt.value = p.é¸æ‰‹å§“å; 
                opt.text = `${p.é¸æ‰‹å§“å} (${p.ç›®å‰ç­‰ç´š})`; 
                sel.appendChild(opt);
            });
        }

        function selectMode(mode) {
            currentMode = mode;
            document.getElementById('currentModeTitle').innerText = mode;
            document.getElementById('gameModeIndicator').innerText = mode;
            document.getElementById('modeOverlay').style.display = 'none';
            document.getElementById('playerOverlay').style.display = 'flex';
            fetchPlayers();
        }

        function setCustomRace(val) {
            selectedCustomRace = val;
            [3, 5, 7, 9].forEach(r => document.getElementById('race' + r).classList.toggle('active', r === val));
        }

        async function checkMatchHistory() {
            const pA = document.getElementById('selectA').value;
            const pB = document.getElementById('selectB').value;
            if (!pA || !pB || pA === pB) return alert("è«‹æ­£ç¢ºé¸æ“‡é¸æ‰‹");
            document.getElementById('startBtn').innerText = "è¼‰å…¥ä¸­...";
            
            try {
                const resp = await fetch(`${GAS_URL}?action=load&pA=${encodeURIComponent(pA)}&pB=${encodeURIComponent(pB)}&mode=${encodeURIComponent(currentMode)}`);
                const result = await resp.json();
                
                currentHistory = result.history; 
                currentHandicaps = result.adjs; 
                lastWinnerName = result.lastWinner; 
                savedData = result.save;
                serverRecRace = result.recRace || 3;
                currentSetScore = result.setScore || {a: 0, b: 0};

                const dataA = playerList.find(x => x.é¸æ‰‹å§“å === pA);
                const dataB = playerList.find(x => x.é¸æ‰‹å§“å === pB);
                
                document.getElementById('welcomeLabel').classList.toggle('hidden', (currentHistory.aWin + currentHistory.bWin > 0));
                document.getElementById('preLastWinnerArea').classList.toggle('hidden', !lastWinnerName);
                if(lastWinnerName) document.getElementById('preLastWinnerName').innerText = lastWinnerName;
                
                // å¹³é»è³½ä¸”éƒ½æ˜¯é«˜æ‰‹æ‰é¡¯ç¤ºè‡ªè¨‚å±€æ•¸
                if (currentMode === 'å¹³é»è³½' && ['S','æ•™ç·´','å®¶é•·'].includes(dataA.ç›®å‰ç­‰ç´š) && ['S','æ•™ç·´','å®¶é•·'].includes(dataB.ç›®å‰ç­‰ç´š)) {
                    document.getElementById('customRaceArea').classList.remove('hidden');
                } else { document.getElementById('customRaceArea').classList.add('hidden'); }
                
                document.getElementById('preNameA').innerText = pA; document.getElementById('preNameB').innerText = pB;
                document.getElementById('preStatsA').innerText = `${currentHistory.aWin} å‹`; document.getElementById('preStatsB').innerText = `${currentHistory.bWin} å‹`;
                
                if (savedData) {
                    document.getElementById('confirmBtn').innerText = `åµæ¸¬åˆ°å­˜æª”ï¼Œé»æ“Šç¹¼çºŒ`;
                    document.getElementById('confirmBtn').classList.replace('bg-blue-600', 'bg-emerald-600');
                } else {
                    if (currentMode === '3-3-1 é©Ÿæ­»è³½') {
                        if(currentSetScore.a === 1 && currentSetScore.b === 1) document.getElementById('confirmBtn').innerText = `ç¢ºèªé–‹å§‹ (é©Ÿæ­»è³½ æ¶1)`;
                        else document.getElementById('confirmBtn').innerText = `ç¢ºèªé–‹å§‹ (æ¶3)`;
                    } else {
                        document.getElementById('confirmBtn').innerText = `ç¢ºèªé–‹å§‹æ¯”è³½`;
                    }
                    document.getElementById('confirmBtn').classList.replace('bg-emerald-600', 'bg-blue-600');
                }
                document.getElementById('previewOverlay').style.display = 'flex';
                document.getElementById('startBtn').innerText = "è¼‰å…¥é¸æ‰‹è³‡æ–™";
            } catch (e) {
                alert("è¼‰å…¥æ­·å²å¤±æ•—ï¼š" + e.message);
                document.getElementById('startBtn').innerText = "é‡è©¦";
            }
        }

        function confirmStart() {
            const pA = document.getElementById('preNameA').innerText;
            const pB = document.getElementById('preNameB').innerText;
            const dataA = playerList.find(x => x.é¸æ‰‹å§“å === pA);
            const dataB = playerList.find(x => x.é¸æ‰‹å§“å === pB);

            // æ¸…é™¤è¦–è¦º
            document.getElementById('trophyA').classList.remove('show');
            document.getElementById('trophyB').classList.remove('show');
            document.getElementById('raceDisplay').classList.remove('text-red-600', 'animate-pulse');
            document.getElementById('raceDisplay').classList.add('text-blue-500');

            if (savedData) {
                // --- å­˜æª”è®€å–æ¨¡å¼ ---
                let s = savedData.score.split(':');
                if (savedData.savedP1 === pA) { scoreA = Number(s[0]); scoreB = Number(s[1]); } 
                else { scoreA = Number(s[1]); scoreB = Number(s[0]); }

                // æ ¹æ“šæ¨¡å¼è¨­å®š (ä¿®å¾©ï¼šå³ä½¿æœ‰å­˜æª”ï¼Œè®“å±€è³½ä¹Ÿå¼·åˆ¶é‡ç®—ç­‰ç´š)
                if (currentMode === 'é›™æ®ºé™å±€è³½') {
                    // é›™æ®ºä¾ç…§æœ€æ–°çš„ adj è¨ˆç®—
                    raceGoalA = Math.min(5, Math.max(3, 5 + (Number(currentHandicaps.adjA) || 0)));
                    raceGoalB = Math.min(5, Math.max(3, 5 + (Number(currentHandicaps.adjB) || 0)));

                } else if (currentMode === 'è®“å±€è³½') {
                    // â˜…â˜…â˜… ä¿®æ­£é»ï¼šå­˜æª”æ™‚ä¹Ÿå¼·åˆ¶ä¾ç­‰ç´šé‡ç®— (S=5, A=4...) â˜…â˜…â˜…
                    const gA = (dataA.ç›®å‰ç­‰ç´š || "").toString().trim().toUpperCase();
                    const gB = (dataB.ç›®å‰ç­‰ç´š || "").toString().trim().toUpperCase();
                    const gradeMap = { 'S': 5, 'A': 4, 'B': 3, 'C': 3 };
                    raceGoalA = gradeMap[gA] !== undefined ? gradeMap[gA] : 5;
                    raceGoalB = gradeMap[gB] !== undefined ? gradeMap[gB] : 5;

                } else if (savedData.raceA) { 
                    raceGoalA = Number(savedData.raceA); raceGoalB = Number(savedData.raceB); 
                } else { 
                    raceGoalA = 5; raceGoalB = 5; 
                }
            } else {
                // --- æ–°æ¯”è³½æ¨¡å¼ ---
                scoreA = 0; scoreB = 0;
                
                if (currentMode === 'é›™æ®ºé™å±€è³½') {
                    // â˜… é›™æ®ºï¼šä¾ç…§å¾Œç«¯å›å‚³çš„ Adj å‹•æ…‹èª¿æ•´
                    raceGoalA = Math.min(5, Math.max(3, 5 + (Number(currentHandicaps.adjA) || 0)));
                    raceGoalB = Math.min(5, Math.max(3, 5 + (Number(currentHandicaps.adjB) || 0)));
                
                } else if (currentMode === 'è®“å±€è³½') {
                    const gA = (dataA.ç›®å‰ç­‰ç´š || "").toString().trim().toUpperCase();
                    const gB = (dataB.ç›®å‰ç­‰ç´š || "").toString().trim().toUpperCase();
                    const gradeMap = { 'S': 5, 'A': 4, 'B': 3, 'C': 3 };
                    raceGoalA = gradeMap[gA] !== undefined ? gradeMap[gA] : 5;
                    raceGoalB = gradeMap[gB] !== undefined ? gradeMap[gB] : 5;

                } else if (currentMode === '3-3-1 é©Ÿæ­»è³½') {
                    if (currentSetScore.a === 1 && currentSetScore.b === 1) { raceGoalA = 1; raceGoalB = 1; } 
                    else { raceGoalA = 3; raceGoalB = 3; }
                
                } else if (currentMode === 'å¹³é»è³½') { 
                    raceGoalA = raceGoalB = selectedCustomRace; 
                
                } else { 
                    raceGoalA = raceGoalB = 5; 
                }
            }

            document.getElementById('displayNameA').innerText = pA; 
            document.getElementById('displayNameB').innerText = pB;
            document.getElementById('sideStatA').innerText = `${currentHistory.aWin} å‹`;
            document.getElementById('sideStatB').innerText = `${currentHistory.bWin} å‹`;
            document.getElementById('raceDisplay').innerText = (raceGoalA === raceGoalB) ? raceGoalA : `${raceGoalA} : ${raceGoalB}`;
            
            if (lastWinnerName) {
                document.getElementById('boardLastWinnerName').innerText = lastWinnerName;
                document.getElementById('boardLastWinnerArea').classList.remove('hidden');
            } else {
                document.getElementById('boardLastWinnerArea').classList.add('hidden');
            }

            // 3-3-1 è¦–è¦ºé‚„åŸ
            if (currentMode === '3-3-1 é©Ÿæ­»è³½') {
                if (currentSetScore.a > 0) document.getElementById('trophyA').classList.add('show');
                if (currentSetScore.b > 0) document.getElementById('trophyB').classList.add('show');
                
                if (raceGoalA === 1) {
                    document.getElementById('raceDisplay').classList.remove('text-blue-500');
                    document.getElementById('raceDisplay').classList.add('text-red-600', 'animate-pulse');
                }
            }

            updateVisuals(); 
            document.getElementById('previewOverlay').style.display = 'none';
            document.getElementById('playerOverlay').style.display = 'none';
        }

        function changeScore(p, v) {
            if (p === 'A') scoreA = Math.max(0, scoreA + v); else scoreB = Math.max(0, scoreB + v);
            updateVisuals();
            
            if (scoreA >= raceGoalA) {
                if (currentMode === '3-3-1 é©Ÿæ­»è³½') handleSetWin('A');
                else showWinner(document.getElementById('displayNameA').innerText);
            }
            else if (scoreB >= raceGoalB) {
                if (currentMode === '3-3-1 é©Ÿæ­»è³½') handleSetWin('B');
                else showWinner(document.getElementById('displayNameB').innerText);
            }
        }

        async function handleSetWin(winnerSide) {
            const winnerName = document.getElementById('displayName' + winnerSide).innerText;
            pendingSetWinner = winnerName; 

            if (winnerSide === 'A') { currentSetScore.a++; document.getElementById('trophyA').classList.add('show'); } 
            else { currentSetScore.b++; document.getElementById('trophyB').classList.add('show'); }

            const r = { pA: document.getElementById('displayNameA').innerText, pB: document.getElementById('displayNameB').innerText, winner: winnerName, mode: currentMode, score: `${scoreA}:${scoreB}`, status: "å·²å®Œè³½", customRace: raceGoalA };
            fetch(GAS_URL, { method: "POST", body: JSON.stringify(r) });

            if (currentSetScore.a >= 2 || currentSetScore.b >= 2) {
                await showWinner(winnerName);
            } else {
                document.getElementById('setWinMsg').innerHTML = `<span class="text-blue-300">${winnerName}</span> æ‹¿ä¸‹æœ¬ç›¤ï¼<br><span class="text-lg text-slate-400 mt-2">ç›®å‰å¤§æ¯”åˆ†ï¼š${currentSetScore.a} - ${currentSetScore.b}</span>`;
                document.getElementById('setWinOverlay').style.display = 'flex';
            }
        }

        function nextSetAction() {
            document.getElementById('setWinOverlay').style.display = 'none';
            scoreA = 0; scoreB = 0;
            if (currentSetScore.a === 1 && currentSetScore.b === 1) {
                raceGoalA = 1; raceGoalB = 1;
                document.getElementById('raceDisplay').classList.remove('text-blue-500');
                document.getElementById('raceDisplay').classList.add('text-red-600', 'animate-pulse');
            } else { raceGoalA = 3; raceGoalB = 3; }
            document.getElementById('raceDisplay').innerText = raceGoalA;
            updateVisuals();
        }

        function updateVisuals() {
            document.getElementById('scoreA').innerText = scoreA;
            document.getElementById('scoreB').innerText = scoreB;
            document.getElementById('scoreA').classList.toggle('on-the-hill', scoreA === raceGoalA - 1);
            document.getElementById('scoreB').classList.toggle('on-the-hill', scoreB === raceGoalB - 1);
        }

        async function showWinner(name) {
            document.getElementById('winnerLabel').innerText = name;
            document.getElementById('winOverlay').style.display = 'flex';
            if (currentMode !== '3-3-1 é©Ÿæ­»è³½') {
                const r = { pA: document.getElementById('displayNameA').innerText, pB: document.getElementById('displayNameB').innerText, winner: name, mode: currentMode, score: `${scoreA}:${scoreB}`, status: "å·²å®Œè³½", customRace: raceGoalA };
                await fetch(GAS_URL, { method: "POST", body: JSON.stringify(r) });
            }
        }

        async function saveProgress() {
            const btn = document.getElementById('mainSaveBtn'); btn.innerText = "å„²å­˜ä¸­...";
            const r = { pA: document.getElementById('displayNameA').innerText, pB: document.getElementById('displayNameB').innerText, mode: currentMode, score: `${scoreA}:${scoreB}`, status: "æœªå®Œè³½", customRace: raceGoalA, customRaceB: raceGoalB };
            await fetch(GAS_URL, { method: "POST", body: JSON.stringify(r) });
            btn.innerText = "å„²å­˜æˆåŠŸ"; setTimeout(() => btn.innerText = "å„²å­˜ç›®å‰é€²åº¦", 2000);
        }
    </script>
</body>
</html>
